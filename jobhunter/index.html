<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Application Tracker System </title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #64748b;
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --font-sans: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { font-family: var(--font-sans); background: var(--bg-body); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }

        /* --- Layout --- */
        aside {
            width: 260px;
            background: #1e293b;
            color: white;
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            flex-shrink: 0;
        }

        aside h1 { font-size: 1.25rem; font-weight: 700; margin-bottom: 2rem; display: flex; align-items: center; gap: 10px; color: var(--primary); }
        aside h1 span { color: white; }

        nav button {
            background: none;
            border: none;
            color: #94a3b8;
            width: 100%;
            text-align: left;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            border-radius: 6px;
            font-size: 0.95rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        nav button:hover { background: #334155; color: white; }
        nav button.active { background: var(--primary); color: white; }

        main { flex: 1; overflow-y: auto; padding: 2rem; position: relative; }

        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Typography & Common --- */
        h2 { font-size: 1.5rem; margin-bottom: 1.5rem; }
        h3 { font-size: 1.1rem; margin-bottom: 1rem; color: var(--text-main); }
        .btn {
            padding: 0.6rem 1.2rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
            transition: opacity 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn:hover { opacity: 0.9; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: white; border: 1px solid var(--border); color: var(--text-main); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.8rem; }

        .card { background: var(--bg-card); border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1.5rem; margin-bottom: 1.5rem; }

        /* --- Dashboard --- */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .kpi-card { background: white; padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--primary); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .kpi-label { color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .kpi-value { font-size: 2rem; font-weight: 700; margin-top: 0.5rem; color: var(--text-main); }
        .kpi-sub { font-size: 0.8rem; margin-top: 0.5rem; }
        .text-green { color: var(--success); }
        .text-red { color: var(--danger); }

        /* --- Table View --- */
        .table-container { overflow-x: auto; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--border); }
        th { background: #f8fafc; font-weight: 600; font-size: 0.85rem; color: var(--text-muted); position: sticky; top: 0; }
        tr:hover { background: #f8fafc; }
        
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.6rem;
            border-radius: 99px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        /* Dynamic status colors will be set in JS */
        
        .priority-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 6px; }

        /* --- Kanban Board --- */
        .kanban-board { display: flex; gap: 1rem; height: calc(100vh - 150px); overflow-x: auto; align-items: flex-start; }
        .kanban-column { 
            min-width: 280px; width: 280px; 
            background: #e2e8f0; 
            border-radius: 8px; 
            display: flex; 
            flex-direction: column; 
            max-height: 100%;
        }
        .kanban-header { padding: 1rem; font-weight: 600; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.03); border-radius: 8px 8px 0 0; }
        .kanban-body { padding: 0.5rem; overflow-y: auto; flex: 1; }
        .kanban-card { background: white; padding: 1rem; border-radius: 6px; margin-bottom: 0.5rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); cursor: grab; border-left: 3px solid transparent; transition: transform 0.1s; }
        .kanban-card:active { transform: scale(0.98); cursor: grabbing; }
        .kanban-card h4 { font-size: 0.95rem; margin-bottom: 0.25rem; }
        .kanban-card p { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.5rem; }
        .kanban-card-meta { display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: var(--text-muted); }

        /* --- Forms --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .modal-overlay.open { display: flex; }
        .modal { background: white; width: 90%; max-width: 800px; max-height: 90vh; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; }
        .modal-header { padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 1.5rem; overflow-y: auto; }
        .modal-footer { padding: 1.5rem; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; background: #f8fafc; }

        .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; }
        .full-width { grid-column: span 2; }
        
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.4rem; font-size: 0.9rem; font-weight: 500; color: var(--text-main); }
        .form-control { width: 100%; padding: 0.6rem; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; font-size: 0.95rem; }
        .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(37,99,235,0.1); }
        textarea.form-control { resize: vertical; min-height: 80px; }

        .tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 1.5rem; }
        .tab-btn { background: none; border: none; padding: 0.75rem 1.5rem; cursor: pointer; color: var(--text-muted); border-bottom: 2px solid transparent; font-weight: 500; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* --- Analytics --- */
        .charts-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 2rem; }
        .chart-box { background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid var(--border); min-height: 300px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        .simple-bar-chart { display: flex; align-items: flex-end; gap: 20px; height: 200px; width: 100%; padding-top: 20px; }
        .bar-group { flex: 1; display: flex; flex-direction: column; align-items: center; height: 100%; justify-content: flex-end; }
        .bar { width: 40px; background: var(--primary); border-radius: 4px 4px 0 0; transition: height 0.5s; position: relative; }
        .bar:hover::after { content: attr(data-val); position: absolute; top: -25px; left: 50%; transform: translateX(-50%); background: #1e293b; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; }
        .bar-label { margin-top: 10px; font-size: 0.75rem; color: var(--text-muted); text-align: center; }

        /* --- Toast Notification --- */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; }
        .toast { background: #334155; color: white; padding: 1rem 1.5rem; border-radius: 6px; margin-top: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); animation: slideIn 0.3s; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* --- Details List --- */
        .details-list dt { font-weight: 600; color: var(--text-muted); margin-top: 10px; font-size: 0.85rem; }
        .details-list dd { margin-left: 0; margin-bottom: 5px; font-size: 0.95rem; }
        .sub-section { border: 1px solid var(--border); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: #fafafa; }
        .sub-section h5 { margin-bottom: 0.5rem; color: var(--primary); display: flex; justify-content: space-between; }
        
        .alert { padding: 10px; border-radius: 6px; font-size: 0.85rem; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .alert-warning { background: #fffbeb; border: 1px solid #fcd34d; color: #92400e; }

        /* Helpers */
        .hidden { display: none !important; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .gap-2 { gap: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
    </style>
</head>
<body>

<!-- Sidebar -->
<aside>
    <h1><span>‚óÜ</span> JobTrack</h1>
    <nav>
        <button onclick="router('dashboard')" id="nav-dashboard" class="active">üìä Dashboard</button>
        <button onclick="router('applications')" id="nav-applications">üìë Applications</button>
        <button onclick="router('kanban')" id="nav-kanban">üìã Kanban</button>
        <button onclick="router('interviews')" id="nav-interviews">üìÖ Interviews</button>
        <button onclick="router('analytics')" id="nav-analytics">üìà Analytics</button>
    </nav>
    <div style="margin-top: auto; font-size: 0.8rem; color: #64748b;">
        <p>Job Application Tracker</p>
        <p>v1.0.0 Local</p>
    </div>
</aside>

<!-- Main Content -->
<main>
    
    <!-- Dashboard View -->
    <section id="view-dashboard" class="view-section active">
        <div class="flex-between" style="margin-bottom: 20px;">
            <h2>Dashboard</h2>
            <button class="btn btn-primary" onclick="openAppModal()">+ New Application</button>
        </div>

        <div class="kpi-grid" id="dashboard-kpis">
            <!-- Injected via JS -->
        </div>

        <div class="form-grid">
            <div class="card">
                <h3>üìå Follow-ups Due Today</h3>
                <div id="dashboard-followups">
                    <p class="text-muted">No follow-ups due today.</p>
                </div>
            </div>
            <div class="card">
                <h3>üö® Ghosted / No Response</h3>
                <div id="dashboard-ghosted">
                    <p class="text-muted">No ghosted applications detected.</p>
                </div>
            </div>
            <div class="card">
                <h3>üìÖ Upcoming Interviews</h3>
                <div id="dashboard-interviews">
                    <p class="text-muted">No upcoming interviews.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Applications List View -->
    <section id="view-applications" class="view-section">
        <div class="flex-between" style="margin-bottom: 20px;">
            <h2>Applications</h2>
            <div style="display:flex; gap: 10px;">
                <input type="text" id="search-apps" placeholder="Search company or title..." class="form-control" style="width: 250px;" onkeyup="renderAppsTable()">
                <button class="btn btn-primary" onclick="openAppModal()">+ Add App</button>
            </div>
        </div>
        
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Company</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Date Applied</th>
                        <th>Source</th>
                        <th>Priority</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="apps-table-body">
                    <!-- Rows injected JS -->
                </tbody>
            </table>
        </div>
    </section>

    <!-- Kanban View -->
    <section id="view-kanban" class="view-section">
        <div class="flex-between" style="margin-bottom: 20px;">
            <h2>Kanban Board</h2>
            <button class="btn btn-primary" onclick="openAppModal()">+ Add App</button>
        </div>
        <div class="kanban-board" id="kanban-container">
            <!-- Columns injected JS -->
        </div>
    </section>

    <!-- Interviews View -->
    <section id="view-interviews" class="view-section">
        <div class="flex-between" style="margin-bottom: 20px;">
            <h2>Interview Timeline</h2>
        </div>
        <div id="interviews-timeline">
            <!-- Timeline injected JS -->
        </div>
    </section>

    <!-- Analytics View -->
    <section id="view-analytics" class="view-section">
        <h2>Analytics & Insights</h2>
        <div class="charts-container">
            <div class="chart-box">
                <h3>Application Funnel</h3>
                <div style="display: flex; gap: 20px; flex-wrap: wrap; justify-content: center;">
                    <canvas id="funnelChart" width="300" height="300"></canvas>
                </div>
            </div>
            <div class="chart-box">
                <h3>Response & Offer Rate</h3>
                <div style="font-size: 3rem; font-weight: bold; color: var(--primary);" id="rate-display">0%</div>
                <p class="text-muted">Interview Rate</p>
                <div style="margin-top: 20px; width: 100%;">
                    <div style="background: #e2e8f0; height: 10px; border-radius: 5px; overflow: hidden;">
                        <div id="rate-bar" style="background: var(--success); height: 100%; width: 0%;"></div>
                    </div>
                </div>
            </div>
            <div class="chart-box full-width">
                <h3>Best Performing Sources</h3>
                <div class="simple-bar-chart" id="source-chart">
                    <!-- Bars injected JS -->
                </div>
            </div>
        </div>
    </section>

</main>

<!-- Modals -->

<!-- Add/Edit Application Modal -->
<div class="modal-overlay" id="app-modal">
    <div class="modal">
        <div class="modal-header">
            <h3 id="modal-title">New Application</h3>
            <button class="btn btn-sm btn-secondary" onclick="closeModal('app-modal')">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab(this, 'tab-main')">Main</button>
                <button class="tab-btn" onclick="switchTab(this, 'tab-details')">Details</button>
                <button class="tab-btn" onclick="switchTab(this, 'tab-research')">Research</button>
            </div>

            <form id="app-form" onsubmit="handleAppSubmit(event)">
                <input type="hidden" id="app-id">
                
                <!-- Tab: Main -->
                <div id="tab-main" class="tab-content active">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Company Name *</label>
                            <input type="text" name="company_name" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Job Title *</label>
                            <input type="text" name="job_title" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Status *</label>
                            <select name="status" id="status-select" class="form-control" required onchange="toggleStatusFields()">
                                <!-- Options Populated by JS -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Priority</label>
                            <select name="priority" class="form-control">
                                <option value="Low">Low</option>
                                <option value="Medium" selected>Medium</option>
                                <option value="High">High</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Date Applied</label>
                            <input type="date" name="date_applied" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Source</label>
                            <select name="job_source" class="form-control">
                                <option value="LinkedIn">LinkedIn</option>
                                <option value="Indeed">Indeed</option>
                                <option value="Referral">Referral</option>
                                <option value="Website">Company Website</option>
                                <option value="Email">Email</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Tab: Details -->
                <div id="tab-details" class="tab-content">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Location</label>
                            <select name="location" class="form-control">
                                <option value="Remote">Remote</option>
                                <option value="Hybrid">Hybrid</option>
                                <option value="On-site">On-site</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Employment Type</label>
                            <select name="employment_type" class="form-control">
                                <option value="Full-time">Full-time</option>
                                <option value="Contract">Contract</option>
                                <option value="Internship">Internship</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Salary Range</label>
                            <input type="text" name="salary_range" class="form-control" placeholder="e.g. 80k - 100k">
                        </div>
                        <div class="form-group">
                            <label>Recruiter Name</label>
                            <input type="text" name="recruiter_name" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Recruiter Email</label>
                            <input type="email" name="recruiter_email" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Job Post URL</label>
                            <input type="url" name="job_post_url" class="form-control">
                        </div>
                        <div class="form-group full-width">
                            <label>Notes</label>
                            <textarea name="notes" class="form-control"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Tab: Research -->
                <div id="tab-research" class="tab-content">
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label>Tech Stack</label>
                            <input type="text" name="tech_stack" class="form-control" placeholder="React, Python, AWS...">
                        </div>
                        <div class="form-group full-width">
                            <label>Culture Notes</label>
                            <textarea name="culture_notes" class="form-control" placeholder="Company culture vibes..."></textarea>
                        </div>
                        <div class="form-group full-width">
                            <label>Interview Prep Notes</label>
                            <textarea name="interview_prep_notes" class="form-control" placeholder="Key concepts to review..."></textarea>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('app-modal')">Cancel</button>
            <button class="btn btn-primary" onclick="document.getElementById('app-form').dispatchEvent(new Event('submit'))">Save Application</button>
        </div>
    </div>
</div>

<!-- Application Detail Modal (View & Edit Sub-entities) -->
<div class="modal-overlay" id="detail-modal">
    <div class="modal" style="max-width: 900px;">
        <div class="modal-header">
            <h3 id="detail-title">Company Name</h3>
            <button class="btn btn-sm btn-secondary" onclick="closeModal('detail-modal')">‚úï</button>
        </div>
        <div class="modal-body" id="detail-content">
            <!-- Loaded dynamically -->
        </div>
    </div>
</div>

<!-- Toast Container -->
<div id="toast-container"></div>

<script>
    /**
     * CONSTANTS & CONFIG
     */
    const STATUS_ENUM = [
        "Saved / Interested", "Applied", "Application Viewed", "Shortlisted", 
        "Assessment Sent", "Assessment Submitted", "Interview ‚Äì HR", 
        "Interview ‚Äì Technical", "Interview ‚Äì Final", "Offer Received", 
        "Offer Accepted", "Rejected", "Withdrawn", "No Response / Ghosted"
    ];

    const STATUS_COLORS = {
        "Saved / Interested": "#64748b", // Grey
        "Applied": "#3b82f6", // Blue
        "Application Viewed": "#8b5cf6", // Purple
        "Shortlisted": "#06b6d4", // Cyan
        "Assessment Sent": "#f59e0b", // Orange
        "Assessment Submitted": "#14b8a6", // Teal
        "Interview ‚Äì HR": "#6366f1", // Indigo
        "Interview ‚Äì Technical": "#ec4899", // Pink
        "Interview ‚Äì Final": "#d946ef", // Fuchsia
        "Offer Received": "#10b981", // Emerald
        "Offer Accepted": "#22c55e", // Green
        "Rejected": "#ef4444", // Red
        "Withdrawn": "#94a3b8", // Light Grey
        "No Response / Ghosted": "#78350f" // Brown
    };

    /**
     * STATE MANAGEMENT
     */
    let applications = JSON.parse(localStorage.getItem('jobTrackerData')) || [];

    function saveData() {
        localStorage.setItem('jobTrackerData', JSON.stringify(applications));
        refreshViews();
    }

    function getApplication(id) {
        return applications.find(app => app.id == id);
    }

    /**
     * INITIALIZATION
     */
    document.addEventListener('DOMContentLoaded', () => {
        populateStatusDropdown();
        // Set today's date as default for new apps
        document.querySelector('input[name="date_applied"]').valueAsDate = new Date();
        refreshViews();
    });

    function router(viewId) {
        // Update Nav
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        document.getElementById(`nav-${viewId}`).classList.add('active');
        
        // Update View
        document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
        document.getElementById(`view-${viewId}`).classList.add('active');

        // Refresh specific view data
        if(viewId === 'dashboard') renderDashboard();
        if(viewId === 'applications') renderAppsTable();
        if(viewId === 'kanban') renderKanban();
        if(viewId === 'interviews') renderInterviews();
        if(viewId === 'analytics') renderAnalytics();
    }

    function refreshViews() {
        // Determine active view and refresh it
        const activeView = document.querySelector('.view-section.active').id;
        if(activeView.includes('dashboard')) renderDashboard();
        if(activeView.includes('applications')) renderAppsTable();
        if(activeView.includes('kanban')) renderKanban();
        if(activeView.includes('interviews') || activeView.includes('dashboard')) renderInterviews(); // Interviews used in dash too
        if(activeView.includes('analytics')) renderAnalytics();
    }

    /**
     * DOM HELPERS
     */
    function populateStatusDropdown() {
        const select = document.getElementById('status-select');
        select.innerHTML = '';
        STATUS_ENUM.forEach(status => {
            const opt = document.createElement('option');
            opt.value = status;
            opt.textContent = status;
            select.appendChild(opt);
        });
    }

    function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        if(type === 'error') toast.style.borderLeft = "4px solid #ef4444";
        if(type === 'success') toast.style.borderLeft = "4px solid #10b981";
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    function switchTab(btn, tabId) {
        const parent = btn.parentElement;
        parent.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        const contentContainer = btn.parentElement.parentElement;
        contentContainer.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        contentContainer.querySelector(`#${tabId}`).classList.add('active');
    }

    function closeModal(id) {
        document.getElementById(id).classList.remove('open');
        if(id === 'app-modal') document.getElementById('app-form').reset();
    }

    /**
     * APPLICATION LOGIC (CRUD)
     */
    function openAppModal(id = null) {
        const modal = document.getElementById('app-modal');
        const form = document.getElementById('app-form');
        const title = document.getElementById('modal-title');
        
        modal.classList.add('open');
        
        if (id) {
            // Edit Mode
            const app = getApplication(id);
            title.textContent = "Edit Application";
            document.getElementById('app-id').value = app.id;
            
            // Populate fields (basic mapping)
            for (const key in app) {
                if (form.elements[key]) {
                    form.elements[key].value = app[key];
                }
            }
        } else {
            // Create Mode
            title.textContent = "New Application";
            document.getElementById('app-id').value = "";
            form.reset();
            form.elements['date_applied'].valueAsDate = new Date();
        }
    }

    function handleAppSubmit(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const id = document.getElementById('app-id').value;
        
        const appData = {
            id: id ? parseInt(id) : Date.now(),
            company_name: formData.get('company_name'),
            job_title: formData.get('job_title'),
            status: formData.get('status'),
            priority: formData.get('priority'),
            date_applied: formData.get('date_applied'),
            job_source: formData.get('job_source'),
            location: formData.get('location'),
            employment_type: formData.get('employment_type'),
            salary_range: formData.get('salary_range'),
            recruiter_name: formData.get('recruiter_name'),
            recruiter_email: formData.get('recruiter_email'),
            job_post_url: formData.get('job_post_url'),
            notes: formData.get('notes'),
            tech_stack: formData.get('tech_stack'),
            culture_notes: formData.get('culture_notes'),
            interview_prep_notes: formData.get('interview_prep_notes'),
            
            // Initialize sub-arrays if new
            history: id ? getApplication(id).history : [],
            interviews: id ? getApplication(id).interviews : [],
            followUps: id ? getApplication(id).followUps : []
        };

        // Handle History if status changed
        if (id) {
            const oldApp = getApplication(id);
            if (oldApp.status !== appData.status) {
                appData.history.push({
                    date: new Date().toISOString(),
                    old_status: oldApp.status,
                    new_status: appData.status,
                    notes: "Status updated manually"
                });
            }
        } else {
            appData.history.push({
                date: new Date().toISOString(),
                old_status: null,
                new_status: appData.status,
                notes: "Application created"
            });
        }

        if (id) {
            const index = applications.findIndex(a => a.id == id);
            applications[index] = appData;
            showToast('Application updated', 'success');
        } else {
            applications.push(appData);
            showToast('Application created', 'success');
        }

        saveData();
        closeModal('app-modal');
    }

    function deleteApp(id) {
        if(confirm('Are you sure you want to delete this application?')) {
            applications = applications.filter(a => a.id !== id);
            saveData();
            showToast('Application deleted', 'error');
        }
    }

    /**
     * DASHBOARD RENDER
     */
    function renderDashboard() {
        // Calculate KPIs
        const total = applications.length;
        const interviews = applications.filter(a => a.status.includes("Interview")).length;
        const offers = applications.filter(a => a.status.includes("Offer")).length;
        const response = applications.filter(a => a.status !== "Saved / Interested" && a.status !== "Applied").length;
        
        // Rates
        const interviewRate = total ? Math.round((interviews / total) * 100) : 0;
        const responseRate = total ? Math.round((response / total) * 100) : 0;

        const kpiHTML = `
            <div class="kpi-card">
                <div class="kpi-label">Total Applications</div>
                <div class="kpi-value">${total}</div>
                <div class="kpi-sub">All time</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Interview Rate</div>
                <div class="kpi-value">${interviewRate}%</div>
                <div class="kpi-sub text-green">${interview} interviews</div>
            </div>
             <div class="kpi-card">
                <div class="kpi-label">Response Rate</div>
                <div class="kpi-value">${responseRate}%</div>
                <div class="kpi-sub text-info">${response} replies</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Offers</div>
                <div class="kpi-value">${offers}</div>
                <div class="kpi-sub text-green">Pending or Accepted</div>
            </div>
        `;
        document.getElementById('dashboard-kpis').innerHTML = kpiHTML;

        // Ghosted (Automation Rule: Applied > 14 days ago & status is still Applied)
        const today = new Date();
        const ghostedApps = applications.filter(a => {
            if (a.status !== 'Applied') return false;
            const appliedDate = new Date(a.date_applied);
            const diffTime = Math.abs(today - appliedDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            return diffDays > 14;
        });

        const ghostedHTML = ghostedApps.length > 0 ? ghostedApps.map(a => `
            <div class="flex-between" style="padding: 8px 0; border-bottom: 1px solid #eee;">
                <div><strong>${a.company_name}</strong></div>
                <button class="btn btn-sm btn-secondary" onclick="openAppModal(${a.id})">Update</button>
            </div>
        `).join('') : '<p class="text-muted">No ghosted applications detected.</p>';
        
        document.getElementById('dashboard-ghosted').innerHTML = ghostedHTML;

        // Follow Ups (Mock Logic for MVP: Show apps that need follow up)
        // In a full app, we'd check a specific next_follow_up_date. 
        // Here we'll randomly flag some for demo or just show a static message for now.
        document.getElementById('dashboard-followups').innerHTML = `<p class="text-muted">Check Interviews list for upcoming tasks.</p>`;
        
        // Upcoming Interviews (Shared logic with interview view, but limited)
        renderUpcomingInterviews('dashboard-interviews', 3);
    }

    /**
     * TABLE VIEW RENDER
     */
    function renderAppsTable() {
        const tbody = document.getElementById('apps-table-body');
        const search = document.getElementById('search-apps').value.toLowerCase();
        
        const filtered = applications.filter(a => 
            a.company_name.toLowerCase().includes(search) || 
            a.job_title.toLowerCase().includes(search)
        ).sort((a,b) => new Date(b.date_applied) - new Date(a.date_applied));

        tbody.innerHTML = filtered.map(app => {
            const statusColor = STATUS_COLORS[app.status] || '#ccc';
            const priorityColor = app.priority === 'High' ? 'red' : (app.priority === 'Medium' ? 'orange' : 'green');
            
            return `
            <tr>
                <td><strong>${app.company_name}</strong></td>
                <td>${app.job_title}</td>
                <td><span class="status-badge" style="background:${statusColor}20; color:${statusColor}; border: 1px solid ${statusColor}40;">${app.status}</span></td>
                <td>${app.date_applied}</td>
                <td>${app.job_source}</td>
                <td><span class="priority-dot" style="background:${priorityColor}"></span>${app.priority}</td>
                <td>
                    <button class="btn btn-sm btn-secondary" onclick="openDetailModal(${app.id})">Details</button>
                    <button class="btn btn-sm btn-secondary" onclick="openAppModal(${app.id})">Edit</button>
                </td>
            </tr>
            `;
        }).join('');
    }

    /**
     * KANBAN RENDER
     */
    function renderKanban() {
        const container = document.getElementById('kanban-container');
        container.innerHTML = '';

        // Group statuses into phases to reduce column count, or just use main ones
        const activeStatuses = ["Saved / Interested", "Applied", "Shortlisted", "Interview ‚Äì HR", "Interview ‚Äì Technical", "Offer Received", "Rejected"];

        activeStatuses.forEach(status => {
            const apps = applications.filter(a => a.status === status);
            const color = STATUS_COLORS[status];

            const col = document.createElement('div');
            col.className = 'kanban-column';
            col.innerHTML = `
                <div class="kanban-header" style="border-bottom: 3px solid ${color}">
                    <span>${status}</span>
                    <span style="background:#fff; padding:2px 8px; border-radius:10px; font-size:0.8rem;">${apps.length}</span>
                </div>
                <div class="kanban-body" id="kanban-${status.replace(/\s+/g, '-')}" ondragover="allowDrop(event)" ondrop="drop(event, '${status}')">
                    ${apps.map(app => `
                        <div class="kanban-card" id="card-${app.id}" draggable="true" ondragstart="drag(event)" onclick="openDetailModal(${app.id})" style="border-left-color: ${app.priority === 'High' ? 'red' : (app.priority === 'Medium' ? 'orange' : 'transparent')}">
                            <h4>${app.company_name}</h4>
                            <p>${app.job_title}</p>
                            <div class="kanban-card-meta">
                                <span>${app.date_applied}</span>
                                <span>${app.job_source}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            container.appendChild(col);
        });
    }

    // Drag & Drop Logic
    function allowDrop(ev) { ev.preventDefault(); }
    function drag(ev) { ev.dataTransfer.setData("text", ev.target.id); }
    function drop(ev, newStatus) {
        ev.preventDefault();
        const data = ev.dataTransfer.getData("text");
        const appId = data.replace('card-', '');
        
        const app = getApplication(appId);
        if(app && app.status !== newStatus) {
            const oldStatus = app.status;
            app.status = newStatus;
            app.history.push({
                date: new Date().toISOString(),
                old_status: oldStatus,
                new_status: newStatus,
                notes: "Moved via Kanban"
            });
            saveData();
            showToast(`Moved ${app.company_name} to ${newStatus}`, 'success');
        }
    }

    /**
     * INTERVIEWS RENDER
     */
    function renderInterviews() {
        renderUpcomingInterviews('interviews-timeline', null);
    }

    function renderUpcomingInterviews(containerId, limit) {
        const container = document.getElementById(containerId);
        // Flatten interviews
        let allInterviews = [];
        applications.forEach(app => {
            app.interviews.forEach(int => {
                allInterviews.push({ ...int, appName: app.company_name, appId: app.id });
            });
        });

        // Sort by date
        allInterviews.sort((a,b) => new Date(a.date) - new Date(b.date));

        // Filter past
        const today = new Date();
        today.setHours(0,0,0,0);
        const upcoming = allInterviews.filter(i => new Date(i.date) >= today);

        if (upcoming.length === 0) {
            if(containerId === 'dashboard-interviews') container.innerHTML = '<p class="text-muted">No upcoming interviews.</p>';
            else container.innerHTML = '<div class="card"><p class="text-muted">No upcoming interviews. Good time to apply for more roles!</p></div>';
            return;
        }

        const list = limit ? upcoming.slice(0, limit) : upcoming;

        container.innerHTML = list.map(int => `
            <div class="card flex-between">
                <div>
                    <h4>${int.appName}</h4>
                    <p class="text-muted">${int.round} with ${int.interviewer_name || 'TBD'}</p>
                    <p style="font-size:0.85rem; margin-top:4px;">üìÖ ${new Date(int.date).toLocaleDateString()} @ ${int.time || 'Time TBD'}</p>
                    <p style="font-size:0.85rem;">üìç ${int.platform || 'Location TBD'}</p>
                </div>
                <div style="text-align:right">
                     <button class="btn btn-sm btn-secondary" onclick="openDetailModal(${int.appId})">View Prep</button>
                </div>
            </div>
        `).join('');
    }

    /**
     * ANALYTICS RENDER
     */
    function renderAnalytics() {
        const canvas = document.getElementById('funnelChart');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Data
        const counts = {};
        STATUS_ENUM.forEach(s => counts[s] = 0);
        applications.forEach(a => {
            if(counts[a.status] !== undefined) counts[a.status]++;
        });

        // Draw Simple Funnel Bar Chart on Canvas
        let y = 10;
        const barHeight = 20;
        const gap = 5;
        
        ctx.font = "12px Arial";
        
        // Filter statuses that have 0 to save space
        const activeStatuses = Object.keys(counts).filter(k => counts[k] > 0);
        const maxVal = Math.max(...Object.values(counts));

        activeStatuses.forEach(status => {
            const count = counts[status];
            const barWidth = (count / maxVal) * 200; 
            
            // Label
            ctx.fillStyle = "#64748b";
            ctx.fillText(status.substring(0, 20) + (status.length>20?'...':''), 10, y + 14);
            
            // Bar
            ctx.fillStyle = STATUS_COLORS[status];
            ctx.fillRect(220, y, barWidth, barHeight);

            // Count
            ctx.fillStyle = "#0f172a";
            ctx.fillText(count, 225 + barWidth + 10, y + 14);

            y += barHeight + gap;
        });

        // Rates Update
        const total = applications.length;
        const interviews = applications.filter(a => a.status.includes("Interview")).length;
        const rate = total ? Math.round((interviews / total) * 100) : 0;
        document.getElementById('rate-display').innerText = rate + "%";
        document.getElementById('rate-bar').style.width = rate + "%";

        // Source Chart
        const sources = {};
        applications.forEach(a => {
            sources[a.job_source] = (sources[a.job_source] || 0) + 1;
        });
        
        const sourceContainer = document.getElementById('source-chart');
        const sourceMax = Math.max(...Object.values(sources));
        
        sourceContainer.innerHTML = Object.keys(sources).map(src => {
            const count = sources[src];
            const heightPct = (count / sourceMax) * 100;
            return `
                <div class="bar-group">
                    <div class="bar" style="height:${heightPct}%; background: var(--primary-dark);" data-val="${count}"></div>
                    <div class="bar-label">${src}</div>
                </div>
            `;
        }).join('');
    }

    /**
     * DETAIL MODAL & SUB-ENTITIES
     */
    function openDetailModal(id) {
        const app = getApplication(id);
        if(!app) return;
        
        const modal = document.getElementById('detail-modal');
        document.getElementById('detail-title').textContent = app.company_name;
        
        const content = document.getElementById('detail-content');
        
        // History HTML
        const historyHTML = app.history.slice().reverse().map(h => `
            <div style="font-size:0.85rem; padding: 8px; border-bottom:1px solid #eee;">
                <span class="text-muted">${new Date(h.date).toLocaleDateString()}</span> 
                <span style="font-weight:bold;">${h.old_status ? `<span style="text-decoration:line-through; color:red;">${h.old_status}</span> ‚Üí` : ''} ${h.new_status}</span>
                <div>${h.notes}</div>
            </div>
        `).join('');

        // Interview HTML
        const interviewListHTML = app.interviews.map((i, idx) => `
            <div class="sub-section">
                <h5>${i.round} <span style="font-weight:normal; font-size:0.8rem">${i.date}</span></h5>
                <dl class="details-list">
                    <dt>Interviewer</dt><dd>${i.interviewer_name || 'N/A'} (${i.interviewer_role || ''})</dd>
                    <dt>Platform</dt><dd>${i.platform || 'N/A'}</dd>
                    <dt>Outcome</dt><dd>${i.outcome || 'Pending'}</dd>
                    <dt>Notes</dt><dd>${i.notes || ''}</dd>
                </dl>
            </div>
        `).join('');

        // Add Interview Form
        const addInterviewHTML = `
            <div class="sub-section" style="background:#fff; border-style:dashed;">
                <h5>Schedule Interview</h5>
                <form onsubmit="addInterview(event, ${app.id})" class="form-grid" style="grid-template-columns: 1fr 1fr;">
                    <input type="date" name="date" class="form-control" required>
                    <input type="text" name="time" placeholder="Time (e.g. 10:00 AM)" class="form-control">
                    <select name="round" class="form-control">
                        <option value="Screening">Screening</option>
                        <option value="Technical">Technical</option>
                        <option value="Behavioral">Behavioral</option>
                        <option value="Final">Final</option>
                    </select>
                    <input type="text" name="interviewer_name" placeholder="Interviewer Name" class="form-control">
                    <input type="text" name="platform" placeholder="Platform (Zoom/Teams)" class="form-control">
                    <button type="submit" class="btn btn-sm btn-primary" style="margin-top:10px;">Add to Timeline</button>
                </form>
            </div>
        `;

        content.innerHTML = `
            <div class="flex-between" style="margin-bottom:20px;">
                <div>
                    <span class="status-badge" style="background:${STATUS_COLORS[app.status]}20; color:${STATUS_COLORS[app.status]}">${app.status}</span>
                    <span class="status-badge" style="background:#eee;">${app.employment_type}</span>
                </div>
                <div>
                    <button class="btn btn-sm btn-danger" onclick="deleteApp(${app.id}); closeModal('detail-modal');">Delete App</button>
                    <button class="btn btn-sm btn-primary" onclick="closeModal('detail-modal'); openAppModal(${app.id});">Edit Main Details</button>
                </div>
            </div>

            <div class="form-grid">
                <div>
                    <h3>Job Info</h3>
                    <dl class="details-list">
                        <dt>Role</dt><dd>${app.job_title}</dd>
                        <dt>Location</dt><dd>${app.location}</dd>
                        <dt>Salary</dt><dd>${app.salary_range || 'N/A'}</dd>
                        <dt>Recruiter</dt><dd>${app.recruiter_name || 'N/A'} (${app.recruiter_email || ''})</dd>
                        <dt>Applied</dt><dd>${app.date_applied}</dd>
                    </dl>
                </div>
                <div>
                    <h3>Research & Prep</h3>
                    <div class="sub-section" style="background:#fff; height: 100%;">
                        <dl class="details-list">
                            <dt>Tech Stack</dt><dd>${app.tech_stack || 'N/A'}</dd>
                            <dt>Culture</dt><dd>${app.culture_notes || 'N/A'}</dd>
                            <dt>Prep Notes</dt><dd>${app.interview_prep_notes || 'N/A'}</dd>
                        </dl>
                    </div>
                </div>
            </div>

            <div style="margin-top:20px;">
                <h3>Interview Timeline</h3>
                <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px;">
                    ${interviewListHTML}
                    ${addInterviewHTML}
                </div>
            </div>

            <div style="margin-top:20px;">
                <h3>Status History</h3>
                <div style="background:#fff; padding:10px; border-radius:6px; border:1px solid #eee; max-height: 150px; overflow-y:auto;">
                    ${historyHTML}
                </div>
            </div>
        `;

        modal.classList.add('open');
    }

    function addInterview(e, appId) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const app = getApplication(appId);
        
        app.interviews.push({
            id: Date.now(),
            date: formData.get('date'),
            time: formData.get('time'),
            round: formData.get('round'),
            interviewer_name: formData.get('interviewer_name'),
            platform: formData.get('platform'),
            outcome: 'Pending',
            notes: ''
        });

        // Auto update status if needed (optional logic, kept manual for strictness)
        
        saveData();
        openDetailModal(appId); // Refresh modal
        showToast('Interview scheduled', 'success');
    }

</script>
</body>
</html>